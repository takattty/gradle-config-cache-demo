name: Configuration Cache Check

on:
  push:
  pull_request:

jobs:
  config-cache-store:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}
          cache-cleanup: never

      - name: Restore configuration cache directory
        uses: actions/cache@v4
        with:
          path: .gradle/configuration-cache
          key: config-cache-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle.properties', '**/settings.gradle*', 'gradle/wrapper/gradle-wrapper.properties') }}

      - name: Store configuration cache
        run: |
          ./gradlew --version

          ./gradlew --configuration-cache help --configuration-cache-problems=warn | tee /tmp/cc-first.log
          if grep -n "Reusing configuration cache" /tmp/cc-first.log; then
            echo "Configuration cache was reused on the first job."
          elif grep -n "Configuration cache entry stored" /tmp/cc-first.log; then
            echo "Configuration cache was stored on the first job."
          else
            echo "Configuration cache was neither stored nor reused on the first job." >&2
            exit 1
          fi

  config-cache-reuse:
    runs-on: ubuntu-latest
    needs: config-cache-store
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}
          cache-cleanup: never

      - name: Restore configuration cache directory
        uses: actions/cache@v4
        with:
          path: .gradle/configuration-cache
          key: config-cache-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle.properties', '**/settings.gradle*', 'gradle/wrapper/gradle-wrapper.properties') }}

      - name: Reuse configuration cache
        run: |
          ./gradlew --configuration-cache help --configuration-cache-problems=warn | tee /tmp/cc-second.log
          if ! grep -n "Reusing configuration cache" /tmp/cc-second.log; then
            echo "Configuration cache was not reused on the second job." >&2
            exit 1
          fi
